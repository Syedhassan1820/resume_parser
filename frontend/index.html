<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sparc Technologies – Resume Parser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Sparc Technologies – Resume Parser</h2>

    <!-- Upload form -->
    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="resumeFile" class="form-label">Upload Resume (PDF/DOCX/TXT)</label>
        <input type="file" id="resumeFile" name="file" class="form-control" accept=".pdf,.docx,.txt" required />
      </div>
      <button type="submit" class="btn btn-primary">Upload & Extract</button>
    </form>

    <div id="loading" class="alert alert-info d-none">Processing resume…</div>
    <div id="error" class="alert alert-danger d-none" role="alert"></div>

    <!-- Result section -->
    <div id="result" class="d-none">
      <h4>Extracted Details</h4>
      <table class="table table-bordered">
        <tbody id="detailsTableBody"></tbody>
      </table>

      <h5>Skills</h5>
      <ul id="skillsList" class="list-group mb-3"></ul>

      <h5>Education</h5>
      <table class="table table-sm table-striped mb-3">
        <thead>
          <tr><th>Degree</th><th>Institute</th><th>Start Year</th><th>End Year</th></tr>
        </thead>
        <tbody id="eduTableBody"></tbody>
      </table>

      <h5>Experience</h5>
      <table class="table table-sm table-striped">
        <thead>
          <tr><th>Job Title</th><th>Company</th><th>From</th><th>To</th><th>Description</th></tr>
        </thead>
        <tbody id="expTableBody"></tbody>
      </table>
    </div>

    <!-- Optional: view all parsed candidates -->
    <div class="mt-4">
      <button id="viewCandidatesBtn" class="btn btn-secondary">View Stored Candidates</button>
      <div id="candidatesList" class="mt-3"></div>
    </div>
  </div>

  <script>
    // ----- CONFIG -----
    // Replace with your Railway backend URL if different
    const API_URL = "https://resumeparser-backend.up.railway.app";

    // ----- UI elements -----
    const form = document.getElementById('uploadForm');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const resultDiv = document.getElementById('result');
    const viewCandidatesBtn = document.getElementById('viewCandidatesBtn');
    const candidatesList = document.getElementById('candidatesList');

    // ----- Submit handler -----
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      hideResult();
      showLoading();

      const fileInput = document.getElementById('resumeFile');
      if (!fileInput.files.length) {
        showError('Please select a file.');
        hideLoading();
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const res = await fetch(`${API_URL}/upload_resume`, {
          method: 'POST',
          body: formData
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          throw new Error('Server returned non-JSON response: ' + text);
        }

        if (!res.ok) {
          throw new Error(data.detail || 'Server error');
        }

        populateResult(data.parsed);
      } catch (err) {
        showError('Error: ' + err.message);
      } finally {
        hideLoading();
      }
    });

    // ----- Helper functions -----
    function showLoading(){ loading.classList.remove('d-none'); }
    function hideLoading(){ loading.classList.add('d-none'); }
    function showError(msg){ errorDiv.textContent = msg; errorDiv.classList.remove('d-none'); }
    function hideError(){ errorDiv.classList.add('d-none'); errorDiv.textContent = ''; }
    function hideResult(){ resultDiv.classList.add('d-none'); }
    function clearTable(tbody){ tbody.innerHTML = ''; }

    function addRow(tbody, label, value){
      const tr = document.createElement('tr');
      tr.innerHTML = `<th style="width:25%">${escapeHtml(label)}</th><td>${escapeHtml(value ?? '')}</td>`;
      tbody.appendChild(tr);
    }

    function populateResult(parsed){
      hideError();
      resultDiv.classList.remove('d-none');

      const detailsBody = document.getElementById('detailsTableBody');
      clearTable(detailsBody);
      addRow(detailsBody, 'Full Name', parsed.full_name);
      addRow(detailsBody, 'Email', parsed.email);
      addRow(detailsBody, 'Phone', parsed.phone);
      addRow(detailsBody, 'Total Experience (years)', parsed.total_experience_years);
      addRow(detailsBody, 'Current Role', parsed.current_role);
      addRow(detailsBody, 'Current Company', parsed.current_company);
      addRow(detailsBody, 'Location', parsed.location);

      const skillsList = document.getElementById('skillsList');
      skillsList.innerHTML = '';
      (parsed.skills || []).forEach(skill => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = skill;
        skillsList.appendChild(li);
      });

      const eduBody = document.getElementById('eduTableBody');
      clearTable(eduBody);
      (parsed.education || []).forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(e.degree || '')}</td>
          <td>${escapeHtml(e.institute || '')}</td>
          <td>${escapeHtml(e.start_year || '')}</td>
          <td>${escapeHtml(e.end_year || '')}</td>
        `;
        eduBody.appendChild(tr);
      });

      const expBody = document.getElementById('expTableBody');
      clearTable(expBody);
      (parsed.experience || []).forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(x.job_title || '')}</td>
          <td>${escapeHtml(x.company || '')}</td>
          <td>${escapeHtml(x.start_date || '')}</td>
          <td>${escapeHtml(x.end_date || '')}</td>
          <td>${escapeHtml(x.description || '')}</td>
        `;
        expBody.appendChild(tr);
      });
    }

    // ----- Simple View Candidates (optional) -----
    viewCandidatesBtn.addEventListener('click', async () => {
      candidatesList.innerHTML = 'Loading...';
      try {
        const res = await fetch(`${API_URL}/candidates`);
        if (!res.ok) throw new Error('Failed to load candidates');
        const rows = await res.json();
        if (!Array.isArray(rows) || rows.length === 0) {
          candidatesList.innerHTML = '<div class="small text-muted">No candidates found.</div>';
          return;
        }
        const table = document.createElement('table');
        table.className = 'table table-sm table-striped';
        table.innerHTML = '<thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Created At</th></tr></thead>';
        const tbody = document.createElement('tbody');
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(r.id)}</td>
                          <td>${escapeHtml(r.full_name)}</td>
                          <td>${escapeHtml(r.email)}</td>
                          <td>${escapeHtml(r.phone)}</td>
                          <td>${escapeHtml(r.current_company)}</td>
                          <td>${escapeHtml(r.created_at)}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        candidatesList.innerHTML = '';
        candidatesList.appendChild(table);
      } catch (err) {
        candidatesList.innerHTML = `<div class="text-danger">Error: ${escapeHtml(err.message)}</div>`;
      }
    });

    // ----- Small helper: escape basic HTML to avoid injection -----
    function escapeHtml(str){
      if (str === null || str === undefined) return '';
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
  </script>
</body>
</html>
